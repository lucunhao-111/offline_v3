import requests
import json
import time
import hashlib
import os
from datetime import datetime

# APIé…ç½®
FX_API_URL = "https://fx.cmbchina.com/api/v1/fx/rate"
DATA_DIR = "fx_data"
history_fx_data = None

def ensure_data_directory():
    """ç¡®ä¿æ•°æ®ç›®å½•å­˜åœ¨"""
    if not os.path.exists(DATA_DIR):
        os.makedirs(DATA_DIR)
        print(f"ğŸ“ åˆ›å»ºæ•°æ®ç›®å½•: {DATA_DIR}")
    return DATA_DIR

def get_fx_data():
    """è·å–å¤–æ±‡æ•°æ®"""

    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
        "Accept": "application/json, text/plain, */*",
        "Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8",
        "Accept-Encoding": "gzip, deflate, br",
        "Referer": "https://fx.cmbchina.com/hq",
        "Origin": "https://fx.cmbchina.com",
        "Sec-Fetch-Dest": "empty",
        "Sec-Fetch-Mode": "cors",
        "Sec-Fetch-Site": "same-origin",
    }

    try:
        print("ğŸŒ æ­£åœ¨è·å–å¤–æ±‡æ•°æ®...")
        response = requests.get(FX_API_URL, headers=headers, timeout=10)
        response.raise_for_status()

        data = response.json()

        # æ·»åŠ æ—¶é—´æˆ³
        current_time = datetime.now()
        formatted_data = {
            "data": data,
            "update_time": current_time.strftime("%Y-%m-%d %H:%M:%S"),
            "timestamp": int(current_time.timestamp())
        }

        print(f"âœ… è·å–å¤–æ±‡æ•°æ®æˆåŠŸ - æ•°æ®æ¡æ•°: {len(data) if isinstance(data, list) else 'æœªçŸ¥'}")
        return formatted_data

    except requests.exceptions.RequestException as e:
        print(f"âŒ ç½‘ç»œè¯·æ±‚å¤±è´¥: {str(e)}")
        return None
    except json.JSONDecodeError as e:
        print(f"âŒ JSONè§£æå¤±è´¥: {str(e)}")
        return None
    except Exception as e:
        print(f"âŒ è·å–å¤–æ±‡æ•°æ®å¤±è´¥: {str(e)}")
        return None

def is_data_updated(new_data, old_data):
    """åˆ¤æ–­æ•°æ®æ˜¯å¦æ›´æ–°"""
    if old_data is None:
        return True
    if new_data is None:
        return False

    try:
        # åˆ›å»ºæ•°æ®çš„å‰¯æœ¬ï¼Œç§»é™¤æ—¶é—´ç›¸å…³å­—æ®µ
        new_copy = new_data.copy()
        old_copy = old_data.copy()

        # ç§»é™¤ä¼šå½±å“æ¯”è¾ƒçš„å­—æ®µ
        new_copy.pop('update_time', None)
        new_copy.pop('timestamp', None)
        old_copy.pop('update_time', None)
        old_copy.pop('timestamp', None)

        # è®¡ç®—å“ˆå¸Œå€¼
        new_hash = hashlib.md5(json.dumps(new_copy, sort_keys=True).encode()).hexdigest()
        old_hash = hashlib.md5(json.dumps(old_copy, sort_keys=True).encode()).hexdigest()

        return new_hash != old_hash

    except Exception as e:
        print(f"æ¯”è¾ƒæ•°æ®æ—¶å‡ºé”™: {e}")
        return True

def save_fx_data(data):
    """ä¿å­˜å¤–æ±‡æ•°æ®"""
    if data:
        try:
            data_dir = ensure_data_directory()

            # åˆ›å»ºæ–‡ä»¶å
            current_time = datetime.now()
            date_str = current_time.strftime("%Y%m%d")
            time_str = current_time.strftime("%H%M%S")

            filename = f"fx_data_{date_str}_{time_str}.json"
            filepath = os.path.join(data_dir, filename)

            with open(filepath, "w", encoding="utf-8") as f:
                json.dump(data, f, ensure_ascii=False, indent=2)

            # æ‰“å°æ¦‚è¦ä¿¡æ¯
            print(f"ğŸ’¾ æ•°æ®å·²ä¿å­˜: {filename}")

            # æ˜¾ç¤ºä¸»è¦è´§å¸å¯¹ä¿¡æ¯
            if 'data' in data and isinstance(data['data'], list):
                print("ğŸ“Š ä¸»è¦è´§å¸å¯¹æ±‡ç‡:")
                major_currencies = ['USD', 'EUR', 'GBP', 'JPY', 'HKD']
                for item in data['data']:
                    if isinstance(item, dict) and item.get('currencyCode') in major_currencies:
                        code = item.get('currencyCode', 'æœªçŸ¥')
                        buy_rate = item.get('buyRate', 'æœªçŸ¥')
                        sell_rate = item.get('sellRate', 'æœªçŸ¥')
                        print(f"   {code}: ä¹°å…¥ {buy_rate} | å–å‡º {sell_rate}")

            return filepath

        except Exception as e:
            print(f"âŒ ä¿å­˜å¤±è´¥: {str(e)}")
            return None

def cleanup_old_files(max_files=100):
    """æ¸…ç†æ—§æ–‡ä»¶ï¼Œåªä¿ç•™æœ€æ–°çš„max_filesä¸ªæ–‡ä»¶"""
    try:
        data_dir = ensure_data_directory()
        files = [f for f in os.listdir(data_dir) if f.endswith('.json')]

        if len(files) > max_files:
            files_with_mtime = []
            for f in files:
                filepath = os.path.join(data_dir, f)
                mtime = os.path.getmtime(filepath)
                files_with_mtime.append((mtime, filepath))

            files_with_mtime.sort()
            files_to_delete = files_with_mtime[:len(files) - max_files]

            for mtime, filepath in files_to_delete:
                os.remove(filepath)
                print(f"ğŸ—‘ï¸  æ¸…ç†æ—§æ–‡ä»¶: {os.path.basename(filepath)}")

    except Exception as e:
        print(f"æ¸…ç†æ–‡ä»¶æ—¶å‡ºé”™: {e}")

def analyze_api_response():
    """åˆ†æAPIå“åº”ç»“æ„"""
    print("ğŸ” åˆ†æAPIå“åº”ç»“æ„...")
    test_data = get_fx_data()

    if test_data and 'data' in test_data:
        data_list = test_data['data']
        if isinstance(data_list, list) and len(data_list) > 0:
            print(f"ğŸ“‹ æ•°æ®æ¡æ•°: {len(data_list)}")
            print("ğŸ“ æ•°æ®ç»“æ„æ ·ä¾‹:")
            sample_item = data_list[0]
            for key, value in sample_item.items():
                print(f"   {key}: {value}")

            # ç»Ÿè®¡è´§å¸ç§ç±»
            currencies = set()
            for item in data_list:
                if isinstance(item, dict) and 'currencyCode' in item:
                    currencies.add(item['currencyCode'])
            print(f"ğŸ’° è´§å¸ç§ç±»: {len(currencies)} ç§")
            print(f"ğŸ’° è´§å¸ä»£ç : {', '.join(sorted(list(currencies))[:10])}...")

    return test_data

def main():
    """ä¸»å‡½æ•°"""
    print("ğŸ’¹ å¼€å§‹å¤–æ±‡æ•°æ®ç›‘æ§ï¼ˆ10ç§’/æ¬¡ï¼‰...")
    data_dir = ensure_data_directory()
    print(f"æ•°æ®ä¿å­˜ç›®å½•: {os.path.abspath(data_dir)}")

    # å…ˆåˆ†æAPIç»“æ„
    global history_fx_data
    history_fx_data = analyze_api_response()

    if history_fx_data:
        save_fx_data(history_fx_data)
        print("âœ… åˆå§‹æ•°æ®è·å–æˆåŠŸ")
    else:
        print("âŒ åˆå§‹æ•°æ®è·å–å¤±è´¥ï¼Œé€€å‡ºç¨‹åº")
        return

    print("\nğŸ”„ å¼€å§‹ç›‘æ§å¾ªç¯ï¼ˆæ¯10ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰...")
    file_count = 1  # åˆå§‹æ–‡ä»¶å·²ç»ä¿å­˜
    check_count = 0

    while True:
        try:
            check_count += 1
            print(f"\n[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] ç¬¬{check_count}æ¬¡æ£€æŸ¥...")

            current_fx_data = get_fx_data()

            if current_fx_data:
                if is_data_updated(current_fx_data, history_fx_data):
                    filepath = save_fx_data(current_fx_data)
                    if filepath:
                        file_count += 1
                        history_fx_data = current_fx_data
                        print(f"ğŸ”„ æ•°æ®å·²æ›´æ–° (ç¬¬{file_count}æ¬¡ä¿å­˜)")

                        # æ˜¾ç¤ºå˜åŒ–ä¿¡æ¯ï¼ˆç®€åŒ–ç‰ˆï¼‰
                        print("ğŸ’¡ æ±‡ç‡æ•°æ®å‘ç”Ÿå˜åŒ–")
                    else:
                        print("âš ï¸  æ•°æ®æœ‰å˜åŒ–ä½†ä¿å­˜å¤±è´¥")
                else:
                    print("â¸ï¸  æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡ä¿å­˜")
            else:
                print("âŒ è·å–æ•°æ®å¤±è´¥")

            # æ¯50æ¬¡æ£€æŸ¥æ¸…ç†ä¸€æ¬¡æ–‡ä»¶
            if check_count % 50 == 0:
                cleanup_old_files(max_files=200)

            # 10ç§’é—´éš”
            print("â° ç­‰å¾…10ç§’åå†æ¬¡æ£€æŸ¥...")
            time.sleep(10)

        except KeyboardInterrupt:
            print("\n\nğŸ‘‹ ç”¨æˆ·ä¸­æ–­ç¨‹åº")
            break
        except Exception as e:
            print(f"âŒ ç›‘æ§å¾ªç¯å‡ºé”™: {e}")
            time.sleep(10)  # å‡ºé”™åç­‰å¾…10ç§’å†é‡è¯•

if __name__ == "__main__":
    main()